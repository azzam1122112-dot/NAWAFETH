# تفعيل OTP Bypass للاختبار على Render

⚠️ **للاختبار/التطوير فقط** — **خطر أمني إذا تم تفعيله على بيانات حقيقية**

## الهدف

تفعيل قبول **أي 4 أرقام عشوائية** في شاشة OTP بدلاً من الكود الصحيح فقط، لتسهيل الاختبار من Flutter app.

---

## خطوات التفعيل على Render

### 1. افتح Render Dashboard

اذهب إلى: [https://dashboard.render.com](https://dashboard.render.com)

### 2. اختر الخدمة

- من قائمة الخدمات، اختر `nawafeth-backend` (أو اسم backend service عندك)

### 3. افتح تبويب Environment

- في صفحة الخدمة، اضغط على تبويب **Environment** (أو **Environment Variables**)

### 4. أضف المتغير البيئي

أضف المتغير التالي:

| Key | Value |
|-----|-------|
| `OTP_APP_BYPASS` | `1` |

- اضغط **Add Environment Variable**
- اكتب في Key: `OTP_APP_BYPASS`
- اكتب في Value: `1`
- اضغط **Save Changes**

### 5. انتظر Deploy التلقائي

- Render سيعيد deploy الخدمة تلقائيًا (يأخذ 2-5 دقائق تقريبًا)
- راقب Logs للتأكد من نجاح البناء والتشغيل

### 6. اختبر من التطبيق

الآن من Flutter app:

1. أدخل رقم جوال
2. اضغط "إرسال الكود"
3. في شاشة OTP: أدخل **أي 4 أرقام** (مثل `1234` أو `9999`)
4. اضغط تحقق → سيقبل أي رقم بدون التحقق من الكود الحقيقي

---

## (اختياري) تقييد الـ Bypass لأرقام معينة فقط

إذا تبغى الـ bypass يشتغل فقط لأرقام اختبار معينة (أكثر أمان):

أضف متغير إضافي:

| Key | Value |
|-----|-------|
| `OTP_APP_BYPASS_ALLOWLIST` | `+966500000000,+966511111111` |

- اكتب أرقام الاختبار مفصولة بفاصلة
- فقط هذه الأرقام راح تقدر تستخدم الـ bypass
- باقي الأرقام راح يطلب الكود الصحيح

---

## ⚠️ تحذيرات أمنية مهمة

1. **لا تفعّل هذا الخيار على production مع بيانات حقيقية**
   - أي شخص يقدر يدخل لأي حساب بأي 4 أرقام
   
2. **استخدم فقط على بيئة اختبار/staging**
   - أرقام وهمية
   - بيانات تجريبية
   
3. **احذف المتغير قبل الإطلاق الرسمي**
   - ارجع لـ Render Dashboard
   - احذف `OTP_APP_BYPASS` أو اضبطه على `0`
   - اضغط Save Changes

---

## إيقاف الـ Bypass بعد الانتهاء من الاختبار

1. ارجع لـ Render Dashboard → nawafeth-backend → Environment
2. احذف المتغير `OTP_APP_BYPASS` **أو** غيّر القيمة من `1` إلى `0`
3. اضغط Save Changes
4. Render سيعيد deploy تلقائيًا

---

## ملاحظات إضافية

- حتى مع تفعيل الـ bypass، التطبيق **يجب** أن يستدعي `/api/accounts/otp/send/` أولاً
- هذا يضمن بقاء حدود الإرسال (rate limits) فعّالة
- كل استخدام للـ bypass يُسجل في logs مع رقم الجوال + IP

---

## استكشاف الأخطاء

### المشكلة: ما زال يطلب الكود الصحيح بعد التفعيل

**الحل:**
1. تأكد أن `OTP_APP_BYPASS=1` موجود في Environment Variables على Render
2. تأكد أن Render أكمل إعادة Deploy بنجاح (شوف Logs)
3. إذا استخدمت `OTP_APP_BYPASS_ALLOWLIST`، تأكد أن رقمك موجود في القائمة بنفس الصيغة

### المشكلة: خطأ عند الدخول

**الحل:**
1. تأكد أنك تستدعي `/api/accounts/otp/send/` قبل `/api/accounts/otp/verify/`
2. شوف logs على Render للأخطاء

---

## التواصل

إذا واجهت مشاكل، راجع:
- `backend/docs/render_deploy.md` (English)
- Render logs لمعرفة الأخطاء التفصيلية
