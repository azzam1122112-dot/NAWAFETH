{% extends "dashboard/base_dashboard.html" %}

{% block title %}طلبات المزود{% endblock %}

{% block content %}
<div class="space-y-5">

  <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div>
      <h1 class="text-xl font-bold">طلبات المزود</h1>
      <div class="text-sm text-gray-500">عرض الطلبات المتاحة والمسندة لك</div>
    </div>

    <div class="flex gap-2">
      <a href="?tab=available" class="px-3 py-2 rounded-xl border {% if tab == 'available' %}bg-indigo-600 text-white border-indigo-600{% else %}border-gray-200{% endif %}">المتاحة</a>
      <a href="?tab=assigned" class="px-3 py-2 rounded-xl border {% if tab == 'assigned' %}bg-indigo-600 text-white border-indigo-600{% else %}border-gray-200{% endif %}">المسندة لي</a>
      {% if request.user.is_staff %}
        <a href="?tab=all" class="px-3 py-2 rounded-xl border {% if tab == 'all' %}bg-indigo-600 text-white border-indigo-600{% else %}border-gray-200{% endif %}">الكل</a>
      {% endif %}
    </div>
  </div>

  <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-3">
    <input type="hidden" name="tab" value="{{ tab }}">
    <input name="q" value="{{ q }}" placeholder="بحث بالعنوان أو الوصف"
           class="rounded-xl border border-gray-200 px-3 py-2" />
    <input name="city" value="{{ city }}" placeholder="المدينة"
           class="rounded-xl border border-gray-200 px-3 py-2" />
    <select name="status" class="rounded-xl border border-gray-200 px-3 py-2">
      <option value="">كل الحالات</option>
      <option value="sent" {% if status == 'sent' %}selected{% endif %}>أُرسل</option>
      <option value="accepted" {% if status == 'accepted' %}selected{% endif %}>مقبول</option>
      <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>قيد التنفيذ</option>
      <option value="completed" {% if status == 'completed' %}selected{% endif %}>مكتمل</option>
      <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>ملغي</option>
    </select>
    <button class="rounded-xl bg-indigo-600 text-white px-4 py-2">تطبيق</button>
  </form>

  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
    {% for obj in page_obj.object_list %}
      <div class="rounded-2xl border border-gray-200 bg-white p-4 space-y-3">
        <div class="flex items-start justify-between gap-2">
          <div>
            <div class="font-semibold">{{ obj.title }}</div>
            <div class="text-sm text-gray-500">{{ obj.city }}</div>
          </div>
          <span class="text-xs px-2 py-1 rounded-full border border-gray-200">
            {{ obj.get_status_display }}
          </span>
        </div>

        <div class="text-sm text-gray-700 line-clamp-3 whitespace-pre-line">
          {{ obj.description|default:"" }}
        </div>

        <div class="flex items-center justify-between">
          <a href="{% url 'marketplace:request_detail' obj.id %}"
             class="text-indigo-700 hover:underline text-sm">
            فتح التفاصيل
          </a>

          {% if tab == 'available' %}
            <form method="post" action="{% url 'marketplace:request_action' obj.id %}">
              {% csrf_token %}
              <button name="action" value="accept" type="submit"
                      class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm">
                قبول
              </button>
            </form>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <div class="rounded-2xl border border-gray-200 bg-white p-6 text-gray-500">
        لا توجد طلبات.
      </div>
    {% endfor %}
  </div>

  {% if page_obj.paginator.num_pages > 1 %}
    <div class="flex items-center justify-center gap-2">
      {% if page_obj.has_previous %}
        <a class="px-3 py-2 rounded-xl border border-gray-200"
           href="?tab={{ tab }}&q={{ q }}&city={{ city }}&status={{ status }}&page={{ page_obj.previous_page_number }}">
          السابق
        </a>
      {% endif %}
      <span class="text-sm text-gray-600">
        صفحة {{ page_obj.number }} من {{ page_obj.paginator.num_pages }}
      </span>
      {% if page_obj.has_next %}
        <a class="px-3 py-2 rounded-xl border border-gray-200"
           href="?tab={{ tab }}&q={{ q }}&city={{ city }}&status={{ status }}&page={{ page_obj.next_page_number }}">
          التالي
        </a>
      {% endif %}
    </div>
  {% endif %}

</div>
{% endblock %}
