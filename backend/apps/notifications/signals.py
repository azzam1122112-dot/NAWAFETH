from django.db.models.signals import post_save
from django.dispatch import receiver

from apps.accounts.models import User
from apps.marketplace.models import Offer, OfferStatus, ServiceRequest, RequestStatusLog
from apps.messaging.models import Message

from .models import EventType
from .services import create_notification


def _status_label(raw: str) -> str:
    s = (raw or "").strip().lower()
    if s in {"new", "sent"}:
        return "جديد"
    if s in {"accepted", "in_progress"}:
        return "تحت التنفيذ"
    if s == "completed":
        return "مكتمل"
    if s in {"cancelled", "canceled", "expired"}:
        return "ملغي"
    return raw or "-"


@receiver(post_save, sender=Offer)
def notify_offer_created(sender, instance: Offer, created, **kwargs):
    if not created:
        return
    sr = instance.request
    # إشعار للعميل فقط
    create_notification(
        user=sr.client,
        title="وصل عرض جديد",
        body=f"تم تقديم عرض على طلبك: {sr.title}",
        kind="info",
        url=f"/requests/{sr.id}",
        actor=instance.provider.user,
        event_type=EventType.OFFER_CREATED,
        request_id=sr.id,
        offer_id=instance.id,
        meta={"price": str(instance.price), "duration_days": instance.duration_days},
    )


@receiver(post_save, sender=Offer)
def notify_offer_selected(sender, instance: Offer, created, **kwargs):
    # نطلق إشعار فقط إذا أصبح SELECTED
    if instance.status != OfferStatus.SELECTED:
        return
    sr = instance.request
    create_notification(
        user=instance.provider.user,
        title="تم اختيار عرضك",
        body=f"العميل اختار عرضك على الطلب: {sr.title}",
        kind="success",
        url=f"/requests/{sr.id}",
        actor=sr.client,
        event_type=EventType.OFFER_SELECTED,
        request_id=sr.id,
        offer_id=instance.id,
    )


@receiver(post_save, sender=Message)
def notify_new_message(sender, instance: Message, created, **kwargs):
    if not created:
        return
    thread = instance.thread

    # Direct thread: notify the other participant.
    if thread.is_direct:
        if instance.sender_id == thread.participant_1_id:
            target_id = thread.participant_2_id
        elif instance.sender_id == thread.participant_2_id:
            target_id = thread.participant_1_id
        else:
            return

        if not target_id:
            return

        target = User.objects.filter(id=target_id).first()
        if not target:
            return

        create_notification(
            user=target,
            title="رسالة جديدة",
            body="لديك رسالة جديدة في المحادثة.",
            kind="info",
            url=f"/threads/{thread.id}/chat",
            actor=instance.sender,
            event_type=EventType.MESSAGE_NEW,
            message_id=instance.id,
            meta={"thread_id": thread.id, "is_direct": True},
        )
        return

    sr = thread.request
    if sr is None:
        return

    # Request thread: notify the opposite party only.
    if sr.provider_id and instance.sender_id == sr.client_id:
        target = sr.provider.user
    elif sr.provider_id and instance.sender_id == sr.provider.user_id:
        target = sr.client
    else:
        return

    create_notification(
        user=target,
        title="رسالة جديدة",
        body="لديك رسالة جديدة على طلبك.",
        kind="info",
        url=f"/requests/{sr.id}/chat",
        actor=instance.sender,
        event_type=EventType.MESSAGE_NEW,
        request_id=sr.id,
        message_id=instance.id,
        meta={"thread_id": thread.id, "is_direct": False},
    )


@receiver(post_save, sender=RequestStatusLog)
def notify_request_status_changed(sender, instance: RequestStatusLog, created, **kwargs):
    if not created:
        return

    sr = instance.request
    actor_id = instance.actor_id
    target = None

    if sr.provider_id and actor_id == sr.client_id:
        target = sr.provider.user
    elif sr.provider_id and sr.provider.user_id == actor_id:
        target = sr.client
    elif sr.provider_id:
        target = sr.client

    if target is None:
        return

    status_label = _status_label(instance.to_status)
    note = (instance.note or "").strip()
    if instance.to_status == "sent" and "اختيار عرض" in note:
        # Offer selection already emits OFFER_SELECTED notification.
        return
    body = f"تم تحديث حالة طلبك ({sr.title}) إلى: {status_label}"
    if note:
        body = f"{body}. {note}"

    create_notification(
        user=target,
        title="تحديث على الطلب",
        body=body,
        kind="info",
        url=f"/requests/{sr.id}",
        actor=instance.actor,
        event_type=EventType.STATUS_CHANGED,
        request_id=sr.id,
        meta={
            "from_status": instance.from_status,
            "to_status": instance.to_status,
            "note": note,
        },
    )
