{% extends "dashboard/base_dashboard.html" %}
{% block title %}تفاصيل تذكرة الدعم{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-2xl font-bold text-cyan-700">تذكرة {{ ticket.code|default:ticket.id }}</h1>
    <p class="text-gray-500 mt-1">{{ ticket.description }}</p>
  </div>
  <a href="{% url 'dashboard:support_tickets_list' %}" class="px-4 py-2 rounded-lg bg-gray-100 font-semibold">رجوع</a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-5">
    <h2 class="font-bold text-lg mb-3">بيانات التذكرة</h2>
    <div class="space-y-2 text-sm">
      <div>العميل: <b>{{ ticket.requester.phone|default:"—" }}</b></div>
      <div>النوع: <b>{{ ticket.get_ticket_type_display }}</b></div>
      <div>الأولوية: <b>{{ ticket.get_priority_display }}</b></div>
      <div>الحالة: <b>{{ ticket.get_status_display }}</b></div>
      <div>الفريق: <b>{{ ticket.assigned_team.name_ar|default:"—" }}</b></div>
      <div>المكلّف: <b>{{ ticket.assigned_to.phone|default:"—" }}</b></div>
    </div>

    <form method="post" action="{% url 'dashboard:support_ticket_assign_action' ticket.id %}" class="mt-4 space-y-2">
      {% csrf_token %}
      <div class="font-semibold">تحديث التعيين</div>
      <select name="assigned_team" class="w-full rounded-lg border-gray-200 px-3 py-2">
        <option value="">بدون فريق</option>
        {% for team in teams %}
          <option value="{{ team.id }}" {% if ticket.assigned_team_id == team.id %}selected{% endif %}>{{ team.name_ar }}</option>
        {% endfor %}
      </select>
      <select name="assigned_to" class="w-full rounded-lg border-gray-200 px-3 py-2">
        <option value="">بدون موظف</option>
        {% for u in staff_users %}
          <option value="{{ u.id }}" {% if ticket.assigned_to_id == u.id %}selected{% endif %}>{{ u.phone|default:u.username|default:u.id }}</option>
        {% endfor %}
      </select>
      <input name="note" placeholder="ملاحظة" class="w-full rounded-lg border-gray-200 px-3 py-2">
      <button class="rounded-lg bg-cyan-600 text-white px-4 py-2 font-semibold">حفظ التعيين</button>
    </form>

    <form method="post" action="{% url 'dashboard:support_ticket_status_action' ticket.id %}" class="mt-5 space-y-2">
      {% csrf_token %}
      <div class="font-semibold">تحديث الحالة</div>
      <select name="status" class="w-full rounded-lg border-gray-200 px-3 py-2">
        {% for v, l in status_choices %}
          <option value="{{ v }}" {% if ticket.status == v %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
      <input name="note" placeholder="ملاحظة الحالة" class="w-full rounded-lg border-gray-200 px-3 py-2">
      <button class="rounded-lg bg-blue-600 text-white px-4 py-2 font-semibold">تحديث الحالة</button>
    </form>
  </div>

  <div class="space-y-6">
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-5">
      <h2 class="font-bold text-lg mb-3">المرفقات</h2>
      <div class="space-y-2">
        {% for a in ticket.attachments.all %}
          <div class="rounded-lg bg-gray-50 p-3 text-sm">
            <div class="font-semibold">
              <a href="{{ a.file.url }}" target="_blank" class="text-cyan-700 hover:underline">
                {{ a.file.name }}
              </a>
            </div>
            <div class="text-gray-500">
              {{ a.created_at|date:"Y-m-d H:i" }} - {{ a.uploaded_by.phone|default:"—" }}
            </div>
          </div>
        {% empty %}
          <div class="text-gray-400 text-sm">لا توجد مرفقات.</div>
        {% endfor %}
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-5">
      <h2 class="font-bold text-lg mb-3">سجل الحالات</h2>
      <div class="space-y-2">
        {% for log in logs %}
          <div class="rounded-lg bg-gray-50 p-3 text-sm">
            <div><b>{{ log.from_status }}</b> ← <b>{{ log.to_status }}</b></div>
            <div class="text-gray-500">{{ log.created_at|date:"Y-m-d H:i" }} - {{ log.changed_by.phone|default:"—" }}</div>
            {% if log.note %}<div class="mt-1">{{ log.note }}</div>{% endif %}
          </div>
        {% empty %}
          <div class="text-gray-400 text-sm">لا يوجد سجل حالات.</div>
        {% endfor %}
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-5">
      <h2 class="font-bold text-lg mb-3">التعليقات</h2>
      <div class="space-y-2">
        {% for c in comments %}
          <div class="rounded-lg bg-gray-50 p-3 text-sm">
            <div class="text-gray-500">{{ c.created_at|date:"Y-m-d H:i" }} - {{ c.created_by.phone|default:"—" }}</div>
            <div class="mt-1">{{ c.text }}</div>
          </div>
        {% empty %}
          <div class="text-gray-400 text-sm">لا توجد تعليقات.</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
